## 目錄
* [目錄](#目錄)
* [hosts](#hosts)
* [Install](#Install)
* [slurm_conf](#slurm_conf)
* [QOS](#OOS)
* [注意事項](#注意事項)
---

## hosts

hosts 不一定要安裝slurm時才設置，可以在系統架設好後就設定(ex: ssh 時可以不用打ip)

```bash
# server
server :~ # vi /etc/hosts
...
127.0.0.1       localhost
...
(外網 ip)       jjc
192.168.122.25  jjc
192.168.122.28  client1 client1
192.168.122.29  client2 client2
192.168.122.30  client3 client3
192.168.122.31  client4 client4

# client
client :~ # vi /etc/hosts
...
127.0.0.1       localhost
...
192.168.122.25  jjc jjc
192.168.122.28  client1 client1
192.168.122.29  client2 client2
192.168.122.30  client3 
192.168.122.31  client4 client4

● 要確保 server 與 client 的 hosts 都設定完成，否則後續 slurm 的服務會有問題
```
---

## Install

```bash
# server (controller)
server :~ # zypper in slurm
server :~ # systemctl enable slurmctld
server :~ # systemctl start slurmctld

# client (node)
client :~ # zypper in slurm-node
client :~ # systemctl enable slurmd
client :~ # systemctl start slurmd

● client 上 slurmd.service 等 slurm.conf 設定完成後再進行啟用
```

---

## slurm_conf

```bash
server :~ # vi /etc/slurm/slurm.conf

# ControlMachine
ControlMachine=jjc

# port config
SlurmctldPort=6817
SlurmdPort=6818

# logfile config
SlurmctldLogFile=/var/log/slurmctld.log
SlurmdLogFile=/var/log/slurmd.log

# node config
NodeName=client1 State=idle CPUs=2 Boards=1 SocketsPerBoard=2 CoresPerSocket=1 ThreadsPerCore=1
NodeName=client2 State=idle CPUs=2 Boards=1 SocketsPerBoard=2 CoresPerSocket=1 ThreadsPerCore=1
NodeName=client3 State=idle CPUs=2 Boards=1 SocketsPerBoard=2 CoresPerSocket=1 ThreadsPerCore=1
NodeName=client4 State=idle CPUs=2 Boards=1 SocketsPerBoard=2 CoresPerSocket=1 ThreadsPerCore=1

# partition config
PartitionName=normal1 Nodes=client[1-4] Default=YES MaxTime=24:00:00 State=UP

```

```bash
server :~ # scp /etc/slurm/slurm.conf root@client3:/etc/slurm/.

client :~ # systemctl enable slurmd
client :~ # systemctl start slurmd

# test
server :~ # srun -N4 hostname
client1
client2
client3
client4

● 把 slurm.conf 複製到每一台client上
● md5sum 確認是否相同

```

---

## QOS

我們可以藉由修改slurm.conf以及sbatch的script中的參數來達到初步的計算資源分配  
QOS可以進一步的幫助我們分配計算資源，例如設定每個使用者同時可submit的作業總數、優先級(priority)等等  

● 查詢Cluster
```bash
server :~ # sacctmgr list cluster                        # 查询Cluster
   Cluster     ControlHost  ControlPort   RPC     Share GrpJobs       GrpTRES GrpSubmit MaxJobs       MaxTRES MaxSubmit     MaxWall                  QOS   Def QOS
---------- --------------- ------------ ----- --------- ------- ------------- --------- ------- ------------- --------- ----------- -------------------- ---------
       cl1                            0     0         1                                                                                           normal
   jjcfarm                            0     0         1                                                                                           normal


server :~ # sacctmgr list cluster format=Cluster,QOS     # 查询Cluster (依照特定格式format=XXX)
   Cluster                  QOS
---------- --------------------
       cl1               normal
   jjcfarm               normal
```

● 創建新Cluster
```bash
server :~ # sacctmgr add cluster linux                   # 創建名為 linux 的 Cluster
 Adding Cluster(s)
  Name           = linux
Would you like to commit changes? (You have 30 seconds to decide)
(N/y): y

server :~ # sacctmgr list cluster format=Cluster,QOS
   Cluster                  QOS
---------- --------------------
       cl1               normal
   jjcfarm               normal
     linux               normal
```
● 查詢/添加Account/User

```bash
server :~ # sacctmgr list account                              # 查詢Account
server :~ # sacctmgr list account format=Cluster,Account,User  # 查詢Account(特定格式)

sacctmgr add user name=test1 account=jjcusers cluster=linux    # 新增一個名為 jjcusers 的 account 到 linux 中
 Adding Account(s)
  jjcusers
 Settings
  Description     = Account Name
  Organization    = Parent/Account Name
 Associations
  A = jjcusers   C = linux
Would you like to commit changes? (You have 30 seconds to decide)
(N/y): y

server :~ # sacctmgr add user name=test1 account=jjcusers cluster=linux  # 將test1(使用者) 新增到 jjcusers 及 linux中
 Associations =
  U = test1     A = jjcusers   C = linux
 Non Default Settings
Would you like to commit changes? (You have 30 seconds to decide)
(N/y): y

server :~ # sacctmgr list account format=Cluster,Account
   Cluster    Account
---------- ----------
                 acc1
             jjcusers
                 root
                 
server :~ # sacctmgr list assoc format=Cluster,Account,User,QOS
   Cluster    Account       User        QOS
---------- ---------- ---------- ----------
       cl1       root                normal
       cl1       root       root     normal
       cl1       acc1                  qos1
       cl1       acc1      test1       qos1
   jjcfarm       root                normal
   jjcfarm       root       root     normal
     linux       root                normal
     linux       root       root     normal
     linux   jjcusers                normal
     linux   jjcusers      test1     normal

● 可以看到最後一行有我們剛剛新增的 user

```

● QOS設定

```bash
server :~ # sacctmgr add qos jjcqos1                         # 新增一個名為jjcqos1的 QOS
 Adding QOS(s)
  jjcqos1
 Settings
  Description    = jjcqos1
Would you like to commit changes? (You have 30 seconds to decide)
(N/y): y

server :~ # sacctmgr modify qos jjcqos1 set priority=10     # 將QOS jjcqos1 的優先級調整為10 (數字越小優先級越高)
server :~ # sacctmgr modify qos jjcqos1 set GrpJobs=2       # 將QOS jjcqos1 Job數量上限設定為2 (若submit超過2個則會等待)
server :~ # sacctmgr show qos format=name,priority,GrpJobs
      Name   Priority GrpJobs
---------- ---------- -------
    normal          0
      qos1       1000
      qos2          0
   jjcqos1         10       2

server :~ # sacctmgr modify user test1 set qos=jjcqos1      # 將 test1 這個user的 QOS 設置為 jjcqos1
server :~ # sacctmgr show assoc format=cluster,user,qos
   Cluster       User                  QOS
---------- ---------- --------------------
     linux                          normal
     linux       root               normal
     linux                          normal
     linux      test1              jjcqos1


● 可以看到最後一行 test1 的 QOS 已經被變更
● 這時候如果使用test1的身分submit4個job，會發現就算計算資源是足夠的，還是只有2個job正在計算，其餘job則會waiting

```




---
(施工中)


## 注意事項
